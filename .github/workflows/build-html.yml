name: Conversion PDF ➜ HTML uniquement

on:
  push:
    paths:
      - "plaquettes/**.pdf"
      - "scripts/convert_pdf_to_html.py"
      - ".github/workflows/convert-only.yml"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout du dépôt
        uses: actions/checkout@v3

      - name: 🐍 Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 📦 Installer les dépendances nécessaires
        run: |
          echo "⏬ Mise à jour de pip et installation de pdf2image + pillow"
          python -m pip install --upgrade pip
          pip install pdf2image pillow

      - name: 🔧 Installer Poppler (nécessaire pour pdf2image)
        run: |
          echo "🔧 Installation de poppler-utils via apt"
          sudo apt-get update && sudo apt-get install -y poppler-utils

      - name: 🗂️ Créer le dossier de sortie (si absent)
        run: |
          echo "📁 Création du dossier html_plaquettes s'il n'existe pas"
          mkdir -p html_plaquettes

      - name: 🖨️ Lancer la conversion PDF ➜ HTML
        run: |
          echo "🚀 Lancement du script de conversion"
          python scripts/convert_pdf_to_html.py

      - name: 🔍 DEBUG – Vérification du token GH_PAT
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "❌ Le secret GH_PAT est vide ou non injecté"
            exit 1
          else
            echo "✅ Le token GH_PAT est bien injecté (longueur approx): ${#{{ secrets.GH_PAT }}} caractères"
          fi

      - name: 📤 Commit & Push des fichiers générés
        run: |
          echo "📝 Configuration Git"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          echo "📦 Ajout des fichiers générés"
          git add html_plaquettes/*.html html_plaquettes/*.png || echo "⚠️ Aucun fichier à ajouter"

          echo "🔍 Diff des fichiers indexés :"
          git diff --cached || true

          echo "🧾 Tentative de commit"
          git diff --cached --quiet || git commit -m "🖼️ Conversion PDF ➜ HTML automatique"

          echo "🚀 Tentative de push avec token"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git# name: Générer les plaquettes HTML

# name: Générer les plaquettes HTML

# on:
#   push:
#     paths:
#       - "plaquettes/**.pdf"
#       - "scripts/*.py"
#       - "index.html"
#       - ".github/workflows/build-html.yml"

# jobs:
#   generate:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout du dépôt
#         uses: actions/checkout@v3

#       - name: Installer Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.11"

#       - name: Installer les dépendances Python
#         run: |
#           python -m pip install --upgrade pip
#           pip install pdf2image pillow

#       - name: Installer Poppler (pour pdf2image)
#         run: sudo apt-get update && sudo apt-get install -y poppler-utils

#       - name: Créer le dossier de sortie (si absent)
#         run: mkdir -p html_plaquettes

#       - name: Générer les versions HTML depuis PDF
#         run: python scripts/convert_pdf_to_html.py

#       - name: Mettre à jour index.html
#         run: python scripts/generate_index.py

#       - name: Commit et push des fichiers générés
#         run: |
#           git config user.name "GitHub Actions"
#           git config user.email "actions@github.com"
#           git add html_plaquettes/*.html html_plaquettes/*.png index.html
#           git diff --cached --quiet || git commit -m "🔄 Génération automatique des HTML plaquettes + index"
#           git push
