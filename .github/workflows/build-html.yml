name: Conversion PDF ➜ HTML uniquement

on:
  push:
    paths:
      - "plaquettes/**.pdf"
      - "scripts/convert_pdf_to_html.py"
      - ".github/workflows/convert-only.yml"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout du dépôt
        uses: actions/checkout@v3

      - name: 🐍 Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 📦 Installer les dépendances nécessaires
        run: |
          echo "⏬ Mise à jour de pip et installation de pdf2image + pillow"
          python -m pip install --upgrade pip
          pip install pdf2image pillow

      - name: 🔧 Installer Poppler (nécessaire pour pdf2image)
        run: |
          echo "🔧 Installation de poppler-utils via apt"
          sudo apt-get update && sudo apt-get install -y poppler-utils

      - name: 🗂️ Créer le dossier de sortie (si absent)
        run: |
          echo "📁 Création du dossier html_plaquettes s'il n'existe pas"
          mkdir -p html_plaquettes

      - name: 🖨️ Lancer la conversion PDF ➜ HTML
        run: |
          echo "🚀 Lancement du script de conversion"
          python scripts/convert_pdf_to_html.py

      - name: 🔍 Vérifie si le token GH_PAT est injecté
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "❌ Le secret GH_PAT est vide ou non injecté"
            exit 1
          else
            echo "✅ Le token GH_PAT est bien injecté (premiers caractères) : $(echo ${{ secrets.GH_PAT }} | cut -c1-4)***"
          fi

      - name: 📤 Commit & Push des fichiers générés
        run: |
          echo "📝 Configuration Git"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          echo "📦 Ajout des fichiers générés"
          git add html_plaquettes/*.html html_plaquettes/*.png || echo "⚠️ Aucun fichier à ajouter"

          echo "🔍 Diff des fichiers indexés :"
          git diff --cached || true

          echo "🧾 Tentative de commit"
          git diff --cached --quiet || git commit -m "🖼️ Conversion PDF ➜ HTML automatique"

          echo "🚀 Tentative de push avec token"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git
